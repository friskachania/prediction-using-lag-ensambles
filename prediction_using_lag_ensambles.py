# -*- coding: utf-8 -*-
"""Prediction using lag ensambles.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1R9EzoriyVlCZx7RvFalUqaxQoWuaZJqd
"""

# install module
!pip install --upgrade pip
!pip install siphon netCDF4 xarray cartopy shapely

from siphon.catalog import TDSCatalog
import xarray as xr
import numpy as np
import cartopy.crs as ccrs
import cartopy.feature as cfeature
from datetime import datetime
import matplotlib.pyplot as plt

import warnings
warnings.simplefilter('ignore')
from siphon.catalog import TDSCatalog
from xarray.backends import NetCDF4DataStore
import xarray as xr

def timelagGFS(file_list, varnames, domain, valid_time_start, valid_time_end):
    """
    Fungsi untuk membuat time-lag ensemble dari data GFS.

    Parameters
    ----------
    file_list : list of str
        List URL THREDDS catalog file GFS
    varnames : str or list of str
        Nama variable yang diambil, bisa 1 atau lebih
    domain : dict
        {'north':.., 'south':.., 'east':.., 'west':..}
    valid_time_start : str or datetime
        Waktu mulai valid
    valid_time_end : str or datetime
        Waktu akhir valid

    Returns
    -------
    xarray.Dataset
        Dataset gabungan semua member sebagai dimensi 'member'
    """
    if isinstance(varnames, str):
        varnames = [varnames]  # jadikan list jika string tunggal

    data_ensemble = []

    for idx, file_url in enumerate(file_list):
        print(f"Processing file {idx+1}/{len(file_list)}: {file_url}")

        # buka catalog
        cat = TDSCatalog(file_url)
        ds = list(cat.datasets.values())[0]
        ncss = ds.subset()

        # buat query
        query = ncss.query()
        query.lonlat_box(north=domain['north'], south=domain['south'],
                         east=domain['east'], west=domain['west'])
        query.time_range(start=valid_time_start, end=valid_time_end)
        query.accept('netcdf4')
        query.variables(*varnames)   # pakai * untuk multiple variables

        # ambil data
        dat = xr.open_dataset(NetCDF4DataStore(ncss.get_data(query)))

        # rename dim time jika perlu
        dat = dat.rename({dat[varnames[0]].dims[0]: 'time'})

        # tambahkan ke list ensemble
        data_ensemble.append(dat)

    # gabungkan semua member di dimensi 'member'
    data_all = xr.concat(data_ensemble, dim='member')

    return data_all

from datetime import datetime, timedelta

# ============================
# PARAMETER
# ============================
start_date = '2025-12-04'   # tanggal awal
end_date   = '2025-12-06'   # tanggal akhir
hours = ['00','06','12','18']  # jam per hari
base_url = 'https://thredds.ucar.edu/thredds/catalog/grib/NCEP/GFS/Global_0p25deg/GFS_Global_0p25deg_{datetime}.grib2/catalog.xml'

# ============================
# BUAT LIST URL OTOMATIS
# ============================
start = datetime.strptime(start_date, '%Y-%m-%d')
end   = datetime.strptime(end_date, '%Y-%m-%d')

delta = end - start
time_lag_list = []

for i in range(delta.days + 1):
    day = start + timedelta(days=i)
    yyyymmdd = day.strftime('%Y%m%d')
    for hh in hours:
        dt_string = f"{yyyymmdd}_{hh}00"
        url = base_url.format(datetime=dt_string)
        time_lag_list.append(url)

# cek hasil
for url in time_lag_list:
    print(url)

#parameter subset
varname=['Precipitation_rate_surface','v-component_of_wind_height_above_ground', 'u-component_of_wind_height_above_ground']
llbox={'north':15,
       'south':-15,
       'west':90,
       'east':150}
valid_s=datetime(2025,12,7,0,0)
valid_e=datetime(2025,12,9,21,0)

#pangggil fungsinya
tlag_ens=timelagGFS(time_lag_list,varname,llbox,valid_s,valid_e)

tlag_ens['Precipitation_rate_surface'] = tlag_ens['Precipitation_rate_surface']*3600*3 #acumulation rr(ch) 3 jam(mm/3 jam)

"""# prediction for 3 days in indoenesia"""

import numpy as np
import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import cartopy.feature as cfeature

# ============================
# PARAMETER
# ============================
times = [
    '2025-12-07 00:00','2025-12-07 06:00','2025-12-07 12:00','2025-12-07 18:00',
    '2025-12-08 00:00','2025-12-08 06:00','2025-12-08 12:00','2025-12-08 18:00',
    '2025-12-09 00:00','2025-12-09 06:00','2025-12-09 12:00','2025-12-09 18:00'
]

height_agl = 10
skip = 5
var_pr = 'Precipitation_rate_surface'
threshold = 0.2     # mm/3h atau sesuai unit

# koordinat meshgrid
lon = tlag_ens.longitude
lat = tlag_ens.latitude
lon_2d, lat_2d = np.meshgrid(lon, lat)

# ============================
# GROUPING PER HARI
# ============================
import pandas as pd
times_pd = pd.to_datetime(times)
days = sorted(list(set(times_pd.date)))

for day in days:
    day_times = [t for t in times_pd if t.date() == day]

    cols = 2  # 2 kolom per figure
    rows = len(day_times) // cols
    if len(day_times) % cols != 0:
        rows += 1

    fig, axes = plt.subplots(rows, cols, figsize=(12*cols, 8*rows), subplot_kw={'projection': ccrs.PlateCarree()})
    axes = np.array(axes).flatten()

    for i, time1 in enumerate(day_times):
        ax = axes[i]
        ax.add_feature(cfeature.BORDERS, edgecolor='gray')
        ax.add_feature(cfeature.COASTLINE, edgecolor='black')
        ax.gridlines(draw_labels=True, linestyle=':')
        # ax.set_extent([95,107,-7,7]) # tuk wilayah tertentu

        # ============================
        # HITUNG PROBABILITY
        # ============================
        dat = tlag_ens[var_pr].sel(time=str(time1))
        prob = (dat > threshold).sum(dim="member") / dat.sizes["member"]

        # ============================
        # ANGIN ENSEMBLE MEAN
        # ============================
        u10 = tlag_ens['u-component_of_wind_height_above_ground'].sel(
            time=str(time1), height_above_ground2=height_agl).mean(dim="member")
        v10 = tlag_ens['v-component_of_wind_height_above_ground'].sel(
            time=str(time1), height_above_ground2=height_agl).mean(dim="member")

        # ============================
        # PLOT PROBABILITY
        # ============================
        prob.plot(
            ax=ax,
            transform=ccrs.PlateCarree(),
            vmin=0.4, vmax=1.0,
            cmap='Blues',
            cbar_kwargs={'shrink':0.5, 'label':'Probability'}
        )

        # ============================
        # QUIVER ANGÄ°N
        # ============================
        Q = ax.quiver(
            lon_2d[::skip, ::skip],
            lat_2d[::skip, ::skip],
            u10.values[::skip, ::skip],
            v10.values[::skip, ::skip],
            transform=ccrs.PlateCarree(),
            scale=200 # skala angin di peta
        )
        ax.quiverkey(Q, X=0.06, Y=1.04, U=5, label="5 m/s", labelpos='E')

        # TITLE
        ax.set_title(f"Probability of Precip (> {threshold}mm) and Surface Wind 10m \n{time1} UTC", fontsize=14)

    # Hapus subplot kosong jika ada
    for j in range(i+1, len(axes)):
        fig.delaxes(axes[j])

    plt.tight_layout()
    plt.show()
    # Jika mau disimpan:
    # plt.savefig(f"prob_wind_{day}.png", dpi=150)

